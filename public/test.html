<!DOCTYPE html>
<html>
<head>
    <title>CSV Parse Test</title>
</head>
<body>
    <h1>CSV Parse Test</h1>
    <div id="output"></div>
    
    <script>
        function parseCSVLine(line) {
          const result = [];
          let current = '';
          let insideQuotes = false;

          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            const nextChar = line[i + 1];

            if (char === '"') {
              if (insideQuotes && nextChar === '"') {
                current += '"';
                i++;
              } else {
                insideQuotes = !insideQuotes;
              }
            } else if (char === ',' && !insideQuotes) {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }

          result.push(current.trim());
          return result;
        }
        
        async function testParse() {
            const res = await fetch('/data/bupa-jeddah.csv');
            const text = await res.text();
            const lines = text.split(/\r?\n/);
            
            console.log('Total lines:', lines.length);
            
            const headerLine = lines[0];
            const headers = parseCSVLine(headerLine).map(h => h.trim());
            console.log('Headers:', headers);
            
            // Parse first 5 rows
            const rows = [];
            for (let i = 1; i < Math.min(6, lines.length); i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                const row = {};
                headers.forEach((header, idx) => {
                    if (header) {
                        row[header] = values[idx] || '';
                    }
                });
                rows.push(row);
            }
            
            console.log('First 5 rows parsed:', rows);
            
            document.getElementById('output').innerHTML = `
                <p>Total lines: ${lines.length}</p>
                <p>Headers count: ${headers.length}</p>
                <p>First row Service Code: ${rows[0]['Service Code']}</p>
                <p>First row 1/1/2026 FEE: ${rows[0]['1/1/2026 FEE']}</p>
                <p>Parsed as number: ${parseFloat((rows[0]['1/1/2026 FEE'] || '').toString().replace(/,/g, ''))}</p>
                <pre>${JSON.stringify(rows[0], null, 2)}</pre>
            `;
        }
        
        testParse().catch(err => {
            console.error('Error:', err);
            document.getElementById('output').innerHTML = `<p>Error: ${err.message}</p>`;
        });
    </script>
</body>
</html>
